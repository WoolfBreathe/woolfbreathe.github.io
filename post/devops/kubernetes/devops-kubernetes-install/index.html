<!DOCTYPE html>
<html lang="zh">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">


  <title>Kubernetes Install-WoolfBreathe</title>
  <meta property="og:title" content="Kubernetes Install" />
  <meta name="twitter:title" content="Kubernetes Install" />

  <meta name="description" content="


配置信息
备注
配置信息
备注




系统版本
Ubuntu20.04
系统版本
CentOS 7.9


Kubernetes
1.20.0
Docker
19.03.x


Etcd
3.4.13
CoreDNS
1.7.0


Calico
3.15.3




Pod网段
172.16.0.0/12
Service网段
10.96.0.0/12






主机名
IP地址
说明




k8s-master01
192.168.1.100
master节点


k8s-master02
192.168.1.101
master节点


k8s-master03
192.168.1.102
master节点


k8s-master-lb（在master节点）
192.168.1.246
keepalived虚拟IP


k8s-node01
192.168.1.103
worker节点


k8s-node02
192.168.1.104
worker节点


">
  <meta property="og:description" content="


配置信息
备注
配置信息
备注




系统版本
Ubuntu20.04
系统版本
CentOS 7.9


Kubernetes
1.20.0
Docker
19.03.x


Etcd
3.4.13
CoreDNS
1.7.0


Calico
3.15.3




Pod网段
172.16.0.0/12
Service网段
10.96.0.0/12






主机名
IP地址
说明




k8s-master01
192.168.1.100
master节点


k8s-master02
192.168.1.101
master节点


k8s-master03
192.168.1.102
master节点


k8s-master-lb（在master节点）
192.168.1.246
keepalived虚拟IP


k8s-node01
192.168.1.103
worker节点


k8s-node02
192.168.1.104
worker节点


">
  <meta name="twitter:description" content="


配置信息
备注
配置信息
备注




系统版本
Ubuntu20.04
系统版本
CentOS 7.9


Kubernetes
1.20.0
Docker
19.03.x


Etcd
3.4.13
CoreDNS
1.7.0


Calico
3.15.3




Pod网段
172.16.0.0/12
Service网段
10.96.0.0/12






主机名
IP …">
  <meta name="author" content="WoolfBreathe"/>
  <link href="/img/favicon.png" rel="icon" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/img/favicon.png"/>
  <meta property="og:image" content="/img/avatar-icon.png" />
  <meta name="twitter:image" content="/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@username" />
  <meta name="twitter:creator" content="@username" />
  <meta property="og:url" content="/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="WoolfBreathe" />

  <meta name="generator" content="Hugo 0.68.3" />
  <link rel="canonical" href="/" />
  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="WoolfBreathe">

  
  
  <link href="https://fonts.googleapis.com/css?family=Lora:400,400i,700%7COpen+Sans:400,700" rel="stylesheet">
  

  <link rel="stylesheet" href='/css/bundle.min.62de9d30b83723e0d55f82908aedb1c5eb18c910bc24bcf43e530ce754ee1502.css' integrity='sha256-Yt6dMLg3I&#43;DVX4KQiu2xxesYyRC8JLz0PlMM51TuFQI='>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
  
  
    
    <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <![endif]-->
<meta name="google-site-verification" content="oKxX4fOvB2yYmU02txZFChM93XQbESU4JaG3tNH9Hm8" />
<meta name="baidu-site-verification" content="F5ojAyqaKU" />
<meta name="keywords" content="DevOps, Kubernetes">




</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">切换导航</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/" title="WoolfBreathe">
        <img src="/img/avatar-icon.png" style="margin-top: -5px;height: 32px;" alt="WoolfBreathe">
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="首页" href="/">首页</a>
            </li>
          
        
          
            <li>
              <a title="归档" href="/archives">归档</a>
            </li>
          
        
          
            <li>
              <a title="标签" href="/tags">标签</a>
            </li>
          
        
          
            <li>
              <a title="关于" href="/page/about/">关于</a>
            </li>
          
        
          
            <li>
              <a title="RSS" href="/index.xml">RSS</a>
            </li>
          
        

        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          

      </ul>
    </div>

  </div>
</nav>


  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">搜索</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script src="/js/algoliasearch.min.js"></script>
<script src="/js/autocomplete.min.js"></script>

<script>
var client = algoliasearch("1JDRAS0AZR", "8804ac109158bb3bb60d74ce98fa332f");
var index = client.initIndex('prod_blog');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            return '<span>' + '<a href="/post/' + suggestion.slug + '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>

    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="/img/banner/photo-1435777940218-be0b632d06db.jpeg" data-img-desc-1="Kubernetes 1.20.0 二进制安装"></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
                <h1>Kubernetes Install</h1>
                  
                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Kubernetes Install</h1>
                
                
                  <span class="post-meta">
  
    发表于 map[Count:2021-05-24]
  
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
  </header>


    

<div class="container" role="main">
  <div class="row">

    
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div>
            
            
            <h5 id="tags" style="margin-top: 30px;">标签:
              
                  <a href="/tags/devops/">DevOps</a> &nbsp;
              
                  <a href="/tags/kubernetes/">Kubernetes</a> &nbsp;
              
            </h5>
            
        </div>
  
        <article role="main" class="blog-post" itemprop="articleBody" id="content">
          
            
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#kubernetes-二进制安装">Kubernetes 二进制安装</a>
      <ul>
        <li><a href="#一基础环境配置以下操作所有节点都得执行">一、基础环境配置（以下操作所有节点都得执行）</a></li>
        <li><a href="#二运行环境准备">二、运行环境准备</a></li>
        <li><a href="#三docker启动">三、Docker启动</a></li>
        <li><a href="#四生成证书">四、生成证书</a></li>
        <li><a href="#五kubernetes系统组件配置">五、Kubernetes系统组件配置</a></li>
        <li><a href="#六高可用配置">六、高可用配置</a></li>
        <li><a href="#七kubernetes组件配置master">七、Kubernetes组件配置(Master)</a></li>
        <li><a href="#八tls-bootstrapping配置">八、TLS Bootstrapping配置</a></li>
        <li><a href="#九node节点配置">九、Node节点配置</a></li>
        <li><a href="#十安装calico">十、安装Calico</a></li>
        <li><a href="#十一安装coredns">十一、安装CoreDNS</a></li>
        <li><a href="#十二安装metrics-server">十二、安装Metrics Server</a></li>
        <li><a href="#十三安装dashboard">十三、安装dashboard</a></li>
      </ul>
    </li>
    <li><a href="#附录">附录</a>
      <ul>
        <li><a href="#参考文档">参考文档</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>

          
  
          
          
          
  
          
          
          
  
          
          
          

          <table>
<thead>
<tr>
<th>配置信息</th>
<th>备注</th>
<th>配置信息</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>系统版本</td>
<td>Ubuntu20.04</td>
<td>系统版本</td>
<td>CentOS 7.9</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>1.20.0</td>
<td>Docker</td>
<td>19.03.x</td>
</tr>
<tr>
<td>Etcd</td>
<td>3.4.13</td>
<td>CoreDNS</td>
<td>1.7.0</td>
</tr>
<tr>
<td>Calico</td>
<td>3.15.3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Pod网段</td>
<td>172.16.0.0/12</td>
<td>Service网段</td>
<td>10.96.0.0/12</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-master01</td>
<td>192.168.1.100</td>
<td>master节点</td>
</tr>
<tr>
<td>k8s-master02</td>
<td>192.168.1.101</td>
<td>master节点</td>
</tr>
<tr>
<td>k8s-master03</td>
<td>192.168.1.102</td>
<td>master节点</td>
</tr>
<tr>
<td>k8s-master-lb（在master节点）</td>
<td>192.168.1.246</td>
<td>keepalived虚拟IP</td>
</tr>
<tr>
<td>k8s-node01</td>
<td>192.168.1.103</td>
<td>worker节点</td>
</tr>
<tr>
<td>k8s-node02</td>
<td>192.168.1.104</td>
<td>worker节点</td>
</tr>
</tbody>
</table>
<h2 id="kubernetes-二进制安装">Kubernetes 二进制安装</h2>
<h3 id="一基础环境配置以下操作所有节点都得执行">一、基础环境配置（以下操作所有节点都得执行）</h3>
<h4 id="11配置hosts解析">1.1、配置hosts解析</h4>
<p>修改主机名字</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">hostnamectl set-hostname k8s-master01
</code></pre></div><p>配置Host文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt;&gt; /etc/hosts <span style="color:#f1fa8c">&lt;&lt; EFO
</span><span style="color:#f1fa8c">127.0.0.1 localhost
</span><span style="color:#f1fa8c">127.0.1.1 k8s-master01
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">192.168.1.100 k8s-api.virtual.local k8s-api
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">192.168.1.100 k8s-master01
</span><span style="color:#f1fa8c">192.168.1.101 k8s-master02
</span><span style="color:#f1fa8c">192.168.1.102 k8s-master03
</span><span style="color:#f1fa8c">192.168.1.246 k8s-master-lb # 如果不是高可用集群，该IP为Master01的IP
</span><span style="color:#f1fa8c">192.168.1.103 k8s-node01
</span><span style="color:#f1fa8c">192.168.1.104 k8s-node02
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><h4 id="12环境变量">1.2、环境变量</h4>
<p><em><strong>每个服务器的NODE_NAME和NODE_NAME需要单独修改</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /etc/profile.d/k8s-env.sh <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c"># TLS Bootstrapping 使用的Token，可以使用命令 head -c 16 /dev/urandom | od -An -t x | tr -d &#39; &#39; 生成
</span><span style="color:#f1fa8c">BOOTSTRAP_TOKEN=&#34;8981b594122ebed7596f1d3b69c78223&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># 建议使用未用的网段来定义服务网段和Pod 网段
</span><span style="color:#f1fa8c"># 服务网段(Service CIDR)，部署前路由不可达，部署后集群内部使用IP:Port可达
</span><span style="color:#f1fa8c">SERVICE_CIDR=&#34;10.254.0.0/16&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># Pod 网段(Cluster CIDR)，部署前路由不可达，部署后路由可达(flanneld 保证)
</span><span style="color:#f1fa8c">CLUSTER_CIDR=&#34;172.30.0.0/16&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># kubernetes 服务IP(预先分配，一般为SERVICE_CIDR中的第一个IP)
</span><span style="color:#f1fa8c">CLUSTER_KUBERNETES_SVC_IP=&#34;10.254.0.1&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># 集群 DNS 服务IP(从SERVICE_CIDR 中预先分配)
</span><span style="color:#f1fa8c">CLUSTER_DNS_SVC_IP=&#34;10.254.0.2&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># 集群 DNS 域名
</span><span style="color:#f1fa8c">CLUSTER_DNS_DOMAIN=&#34;cluster.local.&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># MASTER API Server 地址
</span><span style="color:#f1fa8c">MASTER_URL=&#34;k8s-api.virtual.local&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">KUBE_APISERVER=&#34;https://${MASTER_URL}:6443&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># 服务端口范围(NodePort Range)
</span><span style="color:#f1fa8c">NODE_PORT_RANGE=&#34;30000-32766&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># flanneld 网络配置前缀
</span><span style="color:#f1fa8c">FLANNEL_ETCD_PREFIX=&#34;/kubernetes/network&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># 当前部署的机器名称(随便定义，只要能区分不同机器即可)
</span><span style="color:#f1fa8c">NODE_NAME=&#34;k8s-master01&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># 当前部署的机器IP
</span><span style="color:#f1fa8c">NODE_IP=&#34;192.168.1.100&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># Etcd 集群所有机器 IP
</span><span style="color:#f1fa8c">EtcdNodes=&#34;k8s-master01 k8s-master02 k8s-master03&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># Master 集群所有机器 IP
</span><span style="color:#f1fa8c">MasterNodes=&#34;k8s-master01 k8s-master02 k8s-master03&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># Work 集群所有机器 IP
</span><span style="color:#f1fa8c">WorkNodes=&#34;k8s-node01 k8s-node02&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># CA 集群所有机器 IP
</span><span style="color:#f1fa8c">CANodes=&#34;${CLUSTER_DNS_SVC_IP},${NODE_IP},127.0.0.1,k8s-api.virtual.local,k8s-api,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,k8s-master01,k8s-master02,k8s-master03,k8s-node01,k8s-node02&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># etcd集群服务地址列表
</span><span style="color:#f1fa8c">ETCD_ENDPOINTS=&#34;https://192.168.1.100:2379,https://192.168.1.101:2379,https://192.168.1.102:2379&#34;
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c"># Etcd 集群间通信的IP和端口(注意:服务器名字要和IP对应)
</span><span style="color:#f1fa8c">ETCD_NODES=&#34;k8s-master01=https://192.168.1.100:2380,k8s-master02=https://192.168.1.101:2380,k8s-master03=https://192.168.1.102:2380&#34;
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><h4 id="13更换yum源码centos系统">1.3、更换yum源码(Centos系统)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo

yum install -y yum-utils device-mapper-persistent-data lvm2

yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

cat <span style="color:#f1fa8c">&lt;&lt;EFO &gt; /etc/yum.repos.d/kubernetes.repo
</span><span style="color:#f1fa8c">[kubernetes]
</span><span style="color:#f1fa8c">name=Kubernetes
</span><span style="color:#f1fa8c">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span><span style="color:#f1fa8c">enabled=1
</span><span style="color:#f1fa8c">gpgcheck=1
</span><span style="color:#f1fa8c">repo_gpgcheck=1
</span><span style="color:#f1fa8c">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span><span style="color:#f1fa8c">EFO</span>

sed -i -e <span style="color:#f1fa8c">&#39;/mirrors.cloud.aliyuncs.com/d&#39;</span> -e <span style="color:#f1fa8c">&#39;/mirrors.aliyuncs.com/d&#39;</span> /etc/yum.repos.d/CentOS-Base.repo
</code></pre></div><h4 id="14安装常用工具">1.4、安装常用工具</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git lrzsz -y

yum install ipvsadm ipset sysstat conntrack libseccomp -y
</code></pre></div><h4 id="15关闭防火墙selinuxdnsmasqswap">1.5、关闭防火墙、selinux、dnsmasq、swap</h4>
<p>Centos</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl disable --now firewalld 
systemctl disable --now dnsmasq
systemctl disable --now NetworkManager

setenforce <span style="color:#bd93f9">0</span>
sed -i <span style="color:#f1fa8c">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span> /etc/sysconfig/selinux
sed -i <span style="color:#f1fa8c">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span> /etc/selinux/config
</code></pre></div><p>Ubuntu</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo systemctl disable systemd-resolved
sudo systemctl stop systemd-resolved
sudo rm /etc/resolv.conf
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;nameserver 8.8.8.8&#34;</span> &gt; /etc/resolv.conf
</code></pre></div><p>关闭swap分区</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">swapoff -a <span style="color:#ff79c6">&amp;&amp;</span> sysctl -w vm.swappiness<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>
sed -ri <span style="color:#f1fa8c">&#39;/^[^#]*swap/s@^@#@&#39;</span> /etc/fstab
</code></pre></div><p><a href="#f1.1">附录: 参考文档</a></p>
<h4 id="16时间同步配置">1.6、时间同步配置</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">yum install chrony -y
systemctl <span style="color:#8be9fd;font-style:italic">enable</span> chronyd
systemctl start chronyd
chronyc sources
<span style="color:#bd93f9">210</span> Number of <span style="color:#8be9fd;font-style:italic">sources</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>
MS Name/IP address         Stratum Poll Reach LastRx Last <span style="color:#8be9fd;font-style:italic">sample</span>
<span style="color:#ff79c6">===============================================================================</span>
^+ sv1.ggsrv.de                  <span style="color:#bd93f9">2</span>   <span style="color:#bd93f9">6</span>    <span style="color:#bd93f9">17</span>    <span style="color:#bd93f9">32</span>   -823us<span style="color:#ff79c6">[</span>-1128us<span style="color:#ff79c6">]</span> +/-   98ms
^- montreal.ca.logiplex.net      <span style="color:#bd93f9">2</span>   <span style="color:#bd93f9">6</span>    <span style="color:#bd93f9">17</span>    <span style="color:#bd93f9">32</span>    -17ms<span style="color:#ff79c6">[</span>  -17ms<span style="color:#ff79c6">]</span> +/-  179ms
^- ntp6.flashdance.cx            <span style="color:#bd93f9">2</span>   <span style="color:#bd93f9">6</span>    <span style="color:#bd93f9">17</span>    <span style="color:#bd93f9">32</span>    -32ms<span style="color:#ff79c6">[</span>  -32ms<span style="color:#ff79c6">]</span> +/-  161ms
^* 119.28.183.184                <span style="color:#bd93f9">2</span>   <span style="color:#bd93f9">6</span>    <span style="color:#bd93f9">33</span>    <span style="color:#bd93f9">32</span>   +661us<span style="color:#ff79c6">[</span> +357us<span style="color:#ff79c6">]</span> +/-   38ms
$ date
Tue Aug <span style="color:#bd93f9">27</span> 09:28:41 CST <span style="color:#bd93f9">2019</span>
</code></pre></div><h4 id="17优化linux">1.7、优化Linux</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#8be9fd;font-style:italic">ulimit</span> -SHn <span style="color:#bd93f9">65535</span>

vi /etc/security/limits.conf
<span style="color:#6272a4"># 末尾添加如下内容</span>
* soft nofile <span style="color:#bd93f9">655360</span>
* hard nofile <span style="color:#bd93f9">131072</span>
* soft nproc <span style="color:#bd93f9">655350</span>
* hard nproc <span style="color:#bd93f9">655350</span>
* soft memlock unlimited
* hard memlock unlimited

<span style="color:#6272a4"># 然后重启Linux</span>
reboot
</code></pre></div><h4 id="18安装ipvsadm所有节点">1.8、安装ipvsadm（所有节点）</h4>
<p><em><strong>所有节点配置ipvs模块，在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack， 4.18以下使用nf_conntrack_ipv4即可：</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#6272a4"># 加入以下内容</span>
cat &gt; /etc/modules-load.d/ipvs.conf <span style="color:#f1fa8c">&lt;&lt; EFO
</span><span style="color:#f1fa8c">ip_vs
</span><span style="color:#f1fa8c">ip_vs_lc
</span><span style="color:#f1fa8c">ip_vs_wlc
</span><span style="color:#f1fa8c">ip_vs_rr
</span><span style="color:#f1fa8c">ip_vs_wrr
</span><span style="color:#f1fa8c">ip_vs_lblc
</span><span style="color:#f1fa8c">ip_vs_lblcr
</span><span style="color:#f1fa8c">ip_vs_dh
</span><span style="color:#f1fa8c">ip_vs_sh
</span><span style="color:#f1fa8c">ip_vs_fo
</span><span style="color:#f1fa8c">ip_vs_nq
</span><span style="color:#f1fa8c">ip_vs_sed
</span><span style="color:#f1fa8c">ip_vs_ftp
</span><span style="color:#f1fa8c">ip_vs_sh
</span><span style="color:#f1fa8c">nf_conntrack   # 4.18 改成这个nf_conntrack_ipv4
</span><span style="color:#f1fa8c">ip_tables
</span><span style="color:#f1fa8c">ip_set
</span><span style="color:#f1fa8c">xt_set
</span><span style="color:#f1fa8c">ipt_set
</span><span style="color:#f1fa8c">ipt_rpfilter
</span><span style="color:#f1fa8c">ipt_REJECT
</span><span style="color:#f1fa8c">ipip
</span><span style="color:#f1fa8c">EFO</span>

<span style="color:#6272a4"># 然后执行</span>
systemctl restart systemd-modules-load.service
</code></pre></div><h4 id="19开启一些k8s集群中必须的内核参数配置k8s内核所有节点">1.9、开启一些k8s集群中必须的内核参数，配置k8s内核（所有节点）</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat <span style="color:#f1fa8c">&lt;&lt;EFO &gt; /etc/sysctl.d/k8s.conf
</span><span style="color:#f1fa8c">net.ipv4.ip_forward = 1
</span><span style="color:#f1fa8c">net.bridge.bridge-nf-call-iptables = 1
</span><span style="color:#f1fa8c">net.bridge.bridge-nf-call-ip6tables = 1
</span><span style="color:#f1fa8c">fs.may_detach_mounts = 1
</span><span style="color:#f1fa8c">vm.overcommit_memory=1
</span><span style="color:#f1fa8c">vm.panic_on_oom=0
</span><span style="color:#f1fa8c">fs.inotify.max_user_watches=89100
</span><span style="color:#f1fa8c">fs.file-max=52706963
</span><span style="color:#f1fa8c">fs.nr_open=52706963
</span><span style="color:#f1fa8c">net.netfilter.nf_conntrack_max=2310720
</span><span style="color:#f1fa8c">net.ipv4.tcp_keepalive_time = 600
</span><span style="color:#f1fa8c">net.ipv4.tcp_keepalive_probes = 3
</span><span style="color:#f1fa8c">net.ipv4.tcp_keepalive_intvl =15
</span><span style="color:#f1fa8c">net.ipv4.tcp_max_tw_buckets = 36000
</span><span style="color:#f1fa8c">net.ipv4.tcp_tw_reuse = 1
</span><span style="color:#f1fa8c">net.ipv4.tcp_max_orphans = 327680
</span><span style="color:#f1fa8c">net.ipv4.tcp_orphan_retries = 3
</span><span style="color:#f1fa8c">net.ipv4.tcp_syncookies = 1
</span><span style="color:#f1fa8c">net.ipv4.tcp_max_syn_backlog = 16384
</span><span style="color:#f1fa8c">net.ipv4.ip_conntrack_max = 65536
</span><span style="color:#f1fa8c">net.ipv4.tcp_max_syn_backlog = 16384
</span><span style="color:#f1fa8c">net.ipv4.tcp_timestamps = 0
</span><span style="color:#f1fa8c">net.core.somaxconn = 16384
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><p>重新加载所有的配置文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sysctl --system
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">lsmod | grep --color<span style="color:#ff79c6">=</span>auto -e ip_vs -e nf_conntrack
ip_vs_ftp              <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
nf_nat                 <span style="color:#bd93f9">32768</span>  <span style="color:#bd93f9">1</span> ip_vs_ftp
ip_vs_sed              <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_nq               <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_fo               <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_sh               <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_dh               <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_lblcr            <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_lblc             <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_wrr              <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_rr               <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_wlc              <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs_lc               <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">0</span> 
ip_vs                 <span style="color:#bd93f9">151552</span>  <span style="color:#bd93f9">24</span> ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp
nf_conntrack          <span style="color:#bd93f9">143360</span>  <span style="color:#bd93f9">2</span> nf_nat,ip_vs
nf_defrag_ipv6         <span style="color:#bd93f9">20480</span>  <span style="color:#bd93f9">1</span> nf_conntrack
nf_defrag_ipv4         <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">1</span> nf_conntrack
libcrc32c              <span style="color:#bd93f9">16384</span>  <span style="color:#bd93f9">4</span> nf_conntrack,nf_nat,xfs,ip_vs
</code></pre></div><h3 id="二运行环境准备">二、运行环境准备</h3>
<h4 id="21下载kubernetes安装包">2.1、下载kubernetes安装包</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#6272a4"># 注意目前版本是1.20.0，你们安装时需要下载最新的1.20.x版本：</span>
<span style="color:#6272a4"># https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/</span>
wget https://dl.k8s.io/v1.20.0/kubernetes-server-linux-amd64.tar.gz
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">tar -xf kubernetes-server-linux-amd64.tar.gz
</code></pre></div><h4 id="22下载etcd安装包">2.2、下载etcd安装包</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">tar -zxvf etcd-v3.4.13-linux-amd64.tar.gz --strip-components<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> -C /usr/local/bin etcd-v3.4.13-linux-amd64/etcd<span style="color:#ff79c6">{</span>,ctl<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="23-下载docker所有机器上">2.3 下载docker(所有机器上)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">tar -zxvf docker-19.03.9.tgz
</code></pre></div><h4 id="24-下载calicoctlmaster01">2.4 下载calicoctl(Master01)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -O -L  https://github.com/projectcalico/calicoctl/releases/download/v3.15.3/calicoctl
</code></pre></div><h4 id="25-下载生成证书工具master01">2.5 下载生成证书工具（Master01）</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget <span style="color:#f1fa8c">&#34;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&#34;</span> -O /usr/local/bin/cfssl
wget <span style="color:#f1fa8c">&#34;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&#34;</span> -O /usr/local/bin/cfssljson

mv cfssl_linux-amd64 /usr/local/bin/cfssl
mv cfssljson_linux-amd64  /usr/local/bin/cfssljson
chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</code></pre></div><h4 id="26-创建目录">2.6 创建目录</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mkdir -p /var/lib/cni/
mkdir -p /var/lib/kubelet/
mkdir -p /etc/cni/
mkdir -p /opt/cni/bin/
mkdir -p /etc/kubernetes/manifests/
mkdir -p /etc/kubernetes/pki/etcd/
mkdir -p /var/lib/etcd/
mkdir -p /etc/docker
mkdir -p /etc/etcd/ssl
</code></pre></div><h4 id="27-复制文件">2.7 复制文件</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cp docker/* /usr/local/bin/
cp kubernetes/server/bin/kube<span style="color:#ff79c6">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span style="color:#ff79c6">}</span> /usr/local/bin
cp etcd-v3.4.13-linux-amd64/etcd<span style="color:#ff79c6">{</span>,ctl<span style="color:#ff79c6">}</span> /usr/local/bin
cp cfssl_linux-amd64 /usr/local/bin/cfssl
cp cfssljson_linux-amd64  /usr/local/bin/cfssljson
cp calicoctl /usr/local/bin/
</code></pre></div><h3 id="三docker启动">三、Docker启动</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /etc/docker/daemon.json <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">{  
</span><span style="color:#f1fa8c">    &#34;registry-mirrors&#34;: [
</span><span style="color:#f1fa8c">        &#34;https://registry.aliyuncs.com&#34;,
</span><span style="color:#f1fa8c">        &#34;https://registry.docker-cn.com&#34;,
</span><span style="color:#f1fa8c">        &#34;http://hub-mirror.c.163.com&#34;,
</span><span style="color:#f1fa8c">        &#34;https://docker.mirrors.ustc.edu.cn&#34;
</span><span style="color:#f1fa8c">    ],
</span><span style="color:#f1fa8c">    &#34;exec-opts&#34;: [
</span><span style="color:#f1fa8c">        &#34;native.cgroupdriver=cgroupfs&#34;
</span><span style="color:#f1fa8c">    ],
</span><span style="color:#f1fa8c">    &#34;max-concurrent-downloads&#34;: 10,
</span><span style="color:#f1fa8c">    &#34;max-concurrent-uploads&#34;: 5,
</span><span style="color:#f1fa8c">    &#34;log-opts&#34;: {
</span><span style="color:#f1fa8c">        &#34;max-size&#34;: &#34;300m&#34;,
</span><span style="color:#f1fa8c">        &#34;max-file&#34;: &#34;2&#34;
</span><span style="color:#f1fa8c">    },
</span><span style="color:#f1fa8c">    &#34;live-restore&#34;: true
</span><span style="color:#f1fa8c">}
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /usr/lib/systemd/system/docker.service <span style="color:#f1fa8c">&lt;&lt; EFO
</span><span style="color:#f1fa8c">[Unit]
</span><span style="color:#f1fa8c">Description=Docker Application Container Engine
</span><span style="color:#f1fa8c">Documentation=https://docs.docker.com
</span><span style="color:#f1fa8c">After=network-online.target firewalld.service
</span><span style="color:#f1fa8c">Wants=network-online.target
</span><span style="color:#f1fa8c">[Service]
</span><span style="color:#f1fa8c">Type=notify
</span><span style="color:#f1fa8c">ExecStart=/usr/local/bin/dockerd
</span><span style="color:#f1fa8c">ExecReload=/bin/kill -s HUP $MAINPID
</span><span style="color:#f1fa8c">LimitNOFILE=infinity
</span><span style="color:#f1fa8c">LimitNPROC=infinity
</span><span style="color:#f1fa8c">LimitCORE=infinity
</span><span style="color:#f1fa8c">TimeoutStartSec=0
</span><span style="color:#f1fa8c">Delegate=yes
</span><span style="color:#f1fa8c">KillMode=process
</span><span style="color:#f1fa8c">Restart=on-failure
</span><span style="color:#f1fa8c">StartLimitBurst=3
</span><span style="color:#f1fa8c">StartLimitInterval=60s
</span><span style="color:#f1fa8c">[Install]
</span><span style="color:#f1fa8c">WantedBy=multi-user.target
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl daemon-reload <span style="color:#ff79c6">&amp;&amp;</span> systemctl restart docker
</code></pre></div><h3 id="四生成证书">四、生成证书</h3>
<p><em><strong>二进制安装最关键步骤，一步错误全盘皆输</strong></em></p>
<h4 id="41生成etcd-ca证书和ca证书的key">4.1、生成Etcd CA证书和CA证书的key</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca

cfssl gencert <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -ca<span style="color:#ff79c6">=</span>/etc/etcd/ssl/etcd-ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -ca-key<span style="color:#ff79c6">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -config<span style="color:#ff79c6">=</span>ca-config.json <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -hostname<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">CANodes</span><span style="color:#f1fa8c">}</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -profile<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd

ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
</code></pre></div><h4 id="42k8s组件证书">4.2、k8s组件证书</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca

cfssl gencert <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -ca<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -ca-key<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -config<span style="color:#ff79c6">=</span>ca-config.json <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -hostname<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">CANodes</span><span style="color:#f1fa8c">}</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -profile<span style="color:#ff79c6">=</span>kubernetes apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver
</code></pre></div><p>生成apiserver的聚合证书（Master01节点）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca

cfssl gencert <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -ca<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/front-proxy-ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -ca-key<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -config<span style="color:#ff79c6">=</span>ca-config.json <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -profile<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client
</code></pre></div><p>生成controller-manage的证书（Master01节点）</p>
<p><em><strong>注意，如果不是高可用集群，192.168.1.246:8443改为master01的地址，8443改为apiserver的端口，默认是6443</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cfssl gencert <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -ca<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -ca-key<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -config<span style="color:#ff79c6">=</span>ca-config.json <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   -profile<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager

<span style="color:#6272a4"># set-cluster：设置一个集群项,192.168.1.246是VIP</span>
kubectl config set-cluster kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --certificate-authority<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --embed-certs<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --server<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_APISERVER</span><span style="color:#f1fa8c">}</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/controller-manager.kubeconfig

<span style="color:#6272a4"># 设置一个环境项，一个上下文</span>
kubectl config set-context system:kube-controller-manager@kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --cluster<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --user<span style="color:#ff79c6">=</span>system:kube-controller-manager <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/controller-manager.kubeconfig

<span style="color:#6272a4"># set-credentials 设置一个用户项</span>
kubectl config set-credentials system:kube-controller-manager <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --client-certificate<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/controller-manager.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --client-key<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --embed-certs<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/controller-manager.kubeconfig

<span style="color:#6272a4"># 使用某个环境当做默认环境</span>
kubectl config use-context system:kube-controller-manager@kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/controller-manager.kubeconfig
</code></pre></div><p>生成scheduler的证书（Master01节点）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cfssl gencert <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -ca<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -ca-key<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -config<span style="color:#ff79c6">=</span>ca-config.json <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -profile<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler

<span style="color:#6272a4"># 注意，如果不是高可用集群，192.168.1.246:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span>
kubectl config set-cluster kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --certificate-authority<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --embed-certs<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --server<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_APISERVER</span><span style="color:#f1fa8c">}</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config set-credentials system:kube-scheduler <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --client-certificate<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/scheduler.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --client-key<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/scheduler-key.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --embed-certs<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config set-context system:kube-scheduler@kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --cluster<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --user<span style="color:#ff79c6">=</span>system:kube-scheduler <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config use-context system:kube-scheduler@kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/scheduler.kubeconfig
</code></pre></div><p>生成admin的证书（Master01节点）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cfssl gencert <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -ca<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -ca-key<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -config<span style="color:#ff79c6">=</span>ca-config.json <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    -profile<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin

kubectl config set-cluster kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --certificate-authority<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --embed-certs<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --server<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_APISERVER</span><span style="color:#f1fa8c">}</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/admin.kubeconfig

kubectl config set-credentials kubernetes-admin <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --client-certificate<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/admin.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --client-key<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/admin-key.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --embed-certs<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/admin.kubeconfig

kubectl config set-context kubernetes-admin@kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --cluster<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --user<span style="color:#ff79c6">=</span>kubernetes-admin <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/admin.kubeconfig

kubectl config use-context kubernetes-admin@kubernetes --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/admin.kubeconfig

mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config

</code></pre></div><h4 id="43创建serviceaccount-key-à-secret">4.3、创建ServiceAccount Key à secret</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">openssl genrsa -out /etc/kubernetes/pki/sa.key <span style="color:#bd93f9">2048</span>

openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
</code></pre></div><h3 id="五kubernetes系统组件配置">五、Kubernetes系统组件配置</h3>
<h4 id="51etcd配置所有master节点">5.1、Etcd配置（所有Master节点）</h4>
<p><em><strong>etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /etc/etcd/etcd.config.yaml <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">name: &#39;${NODE_NAME}&#39;
</span><span style="color:#f1fa8c">data-dir: /var/lib/etcd
</span><span style="color:#f1fa8c">wal-dir: /var/lib/etcd/wal
</span><span style="color:#f1fa8c">snapshot-count: 5000
</span><span style="color:#f1fa8c">heartbeat-interval: 100
</span><span style="color:#f1fa8c">election-timeout: 1000
</span><span style="color:#f1fa8c">quota-backend-bytes: 0
</span><span style="color:#f1fa8c">listen-peer-urls: &#39;https://${NODE_IP}:2380&#39;
</span><span style="color:#f1fa8c">listen-client-urls: &#39;https://${NODE_IP}:2379,http://127.0.0.1:2379&#39;
</span><span style="color:#f1fa8c">max-snapshots: 3
</span><span style="color:#f1fa8c">max-wals: 5
</span><span style="color:#f1fa8c">cors:
</span><span style="color:#f1fa8c">initial-advertise-peer-urls: &#39;https://${NODE_IP}:2380&#39;
</span><span style="color:#f1fa8c">advertise-client-urls: &#39;https://${NODE_IP}:2379&#39;
</span><span style="color:#f1fa8c">discovery:
</span><span style="color:#f1fa8c">discovery-fallback: &#39;proxy&#39;
</span><span style="color:#f1fa8c">discovery-proxy:
</span><span style="color:#f1fa8c">discovery-srv:
</span><span style="color:#f1fa8c">initial-cluster: &#39;${ETCD_NODES}&#39;
</span><span style="color:#f1fa8c">initial-cluster-token: &#39;etcd-k8s-cluster&#39;
</span><span style="color:#f1fa8c">initial-cluster-state: &#39;new&#39;
</span><span style="color:#f1fa8c">strict-reconfig-check: false
</span><span style="color:#f1fa8c">enable-v2: true
</span><span style="color:#f1fa8c">enable-pprof: true
</span><span style="color:#f1fa8c">proxy: &#39;off&#39;
</span><span style="color:#f1fa8c">proxy-failure-wait: 5000
</span><span style="color:#f1fa8c">proxy-refresh-interval: 30000
</span><span style="color:#f1fa8c">proxy-dial-timeout: 1000
</span><span style="color:#f1fa8c">proxy-write-timeout: 5000
</span><span style="color:#f1fa8c">proxy-read-timeout: 0
</span><span style="color:#f1fa8c">client-transport-security:
</span><span style="color:#f1fa8c">  cert-file: &#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;
</span><span style="color:#f1fa8c">  key-file: &#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;
</span><span style="color:#f1fa8c">  client-cert-auth: true
</span><span style="color:#f1fa8c">  trusted-ca-file: &#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;
</span><span style="color:#f1fa8c">  auto-tls: true
</span><span style="color:#f1fa8c">peer-transport-security:
</span><span style="color:#f1fa8c">  cert-file: &#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;
</span><span style="color:#f1fa8c">  key-file: &#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;
</span><span style="color:#f1fa8c">  peer-client-cert-auth: true
</span><span style="color:#f1fa8c">  trusted-ca-file: &#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;
</span><span style="color:#f1fa8c">  auto-tls: true
</span><span style="color:#f1fa8c">debug: false
</span><span style="color:#f1fa8c">log-package-levels:
</span><span style="color:#f1fa8c">log-outputs: [default]
</span><span style="color:#f1fa8c">force-new-cluster: false
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><h4 id="52创建service">5.2、创建Service</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /usr/lib/systemd/system/etcd.service <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">[Unit]
</span><span style="color:#f1fa8c">Description=Etcd Service
</span><span style="color:#f1fa8c">Documentation=https://coreos.com/etcd/docs/latest/
</span><span style="color:#f1fa8c">After=network.target
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Service]
</span><span style="color:#f1fa8c">Type=notify
</span><span style="color:#f1fa8c">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yaml
</span><span style="color:#f1fa8c">Restart=on-failure
</span><span style="color:#f1fa8c">RestartSec=10
</span><span style="color:#f1fa8c">LimitNOFILE=65536
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Install]
</span><span style="color:#f1fa8c">WantedBy=multi-user.target
</span><span style="color:#f1fa8c">Alias=etcd3.service
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><h4 id="53启动并查看集群状态任意master">5.3、启动并查看集群状态（任意master）</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl daemon-reload <span style="color:#ff79c6">&amp;&amp;</span> systemctl restart etcd

etcdctl --endpoints<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">ETCD_ENDPOINTS</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --cacert<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --cert<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/etcd/etcd.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --key<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    endpoint status --write-out<span style="color:#ff79c6">=</span>table
</code></pre></div><p>输出如下结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|      ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| 192.168.1.102:2379 | a77e5ca7bd4dc035 |  3.4.13 |   20 kB |     false |      false |       465 |          9 |                  9 |        |
| 192.168.1.101:2379 | e3adc675ac3b3dbd |  3.4.13 |   20 kB |     false |      false |       465 |          9 |                  9 |        |
| 192.168.1.100:2379 | 47a087175e3f17b3 |  3.4.13 |   20 kB |      true |      false |       465 |          9 |                  9 |        |
+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</code></pre></div><h3 id="六高可用配置">六、高可用配置</h3>
<h3 id="七kubernetes组件配置master">七、Kubernetes组件配置(Master)</h3>
<h4 id="71apiserver">7.1、apiserver</h4>
<p><em><strong>所有Master节点创建kube-apiserver service，# 注意，如果不是高可用集群，192.168.1.246改为master01的地址</strong></em></p>
<p><em><strong>注意本文档使用的k8s service网段为10.96.0.0/12，该网段不能和宿主机的网段、Pod网段的重复，请按需修改</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /usr/lib/systemd/system//kube-apiserver.service <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">[Unit]
</span><span style="color:#f1fa8c">Description=Kubernetes API Server
</span><span style="color:#f1fa8c">Documentation=https://github.com/kubernetes/kubernetes
</span><span style="color:#f1fa8c">After=network.target
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Service]
</span><span style="color:#f1fa8c">ExecStart=/usr/local/bin/kube-apiserver \\
</span><span style="color:#f1fa8c">      --v=2 \\
</span><span style="color:#f1fa8c">      --logtostderr=true \\
</span><span style="color:#f1fa8c">      --allow-privileged=true \\
</span><span style="color:#f1fa8c">      --bind-address=0.0.0.0 \\
</span><span style="color:#f1fa8c">      --secure-port=6443 \\
</span><span style="color:#f1fa8c">      --insecure-port=0 \\
</span><span style="color:#f1fa8c">      --advertise-address=${NODE_IP} \\
</span><span style="color:#f1fa8c">      --service-cluster-ip-range=${SERVICE_CIDR} \\
</span><span style="color:#f1fa8c">      --service-node-port-range=${NODE_PORT_RANGE} \\
</span><span style="color:#f1fa8c">      --etcd-servers=${ETCD_ENDPOINTS} \\
</span><span style="color:#f1fa8c">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\
</span><span style="color:#f1fa8c">      --etcd-certfile=/etc/etcd/ssl/etcd.pem \\
</span><span style="color:#f1fa8c">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\
</span><span style="color:#f1fa8c">      --client-ca-file=/etc/kubernetes/pki/ca.pem \\
</span><span style="color:#f1fa8c">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\
</span><span style="color:#f1fa8c">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\
</span><span style="color:#f1fa8c">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\
</span><span style="color:#f1fa8c">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\
</span><span style="color:#f1fa8c">      --service-account-key-file=/etc/kubernetes/pki/sa.pub \\
</span><span style="color:#f1fa8c">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\
</span><span style="color:#f1fa8c">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
</span><span style="color:#f1fa8c">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\
</span><span style="color:#f1fa8c">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\
</span><span style="color:#f1fa8c">      --authorization-mode=Node,RBAC \\
</span><span style="color:#f1fa8c">      --enable-bootstrap-token-auth=true \\
</span><span style="color:#f1fa8c">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\
</span><span style="color:#f1fa8c">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\
</span><span style="color:#f1fa8c">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\
</span><span style="color:#f1fa8c">      --requestheader-allowed-names=aggregator \\
</span><span style="color:#f1fa8c">      --requestheader-group-headers=X-Remote-Group \\
</span><span style="color:#f1fa8c">      --requestheader-extra-headers-prefix=X-Remote-Extra- \\
</span><span style="color:#f1fa8c">      --requestheader-username-headers=X-Remote-User
</span><span style="color:#f1fa8c">      # --token-auth-file=/etc/kubernetes/token.csv
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">Restart=on-failure
</span><span style="color:#f1fa8c">RestartSec=10s
</span><span style="color:#f1fa8c">LimitNOFILE=65535
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Install]
</span><span style="color:#f1fa8c">WantedBy=multi-user.target
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><p>启动apiserver（所有Master节点）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl daemon-reload <span style="color:#ff79c6">&amp;&amp;</span> systemctl restart kube-apiserver
</code></pre></div><h4 id="72配置kube-controller-manager-service-所有master节点">7.2、配置kube-controller-manager service （所有Master节点）</h4>
<p><em><strong>注意本文档使用的k8s Pod网段为172.16.0.0/12，该网段不能和宿主机的网段、k8s Service网段的重复，请按需修改</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /usr/lib/systemd/system//kube-controller-manager.service <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">[Unit]
</span><span style="color:#f1fa8c">Description=Kubernetes Controller Manager
</span><span style="color:#f1fa8c">Documentation=https://github.com/kubernetes/kubernetes
</span><span style="color:#f1fa8c">After=network.target
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Service]
</span><span style="color:#f1fa8c">ExecStart=/usr/local/bin/kube-controller-manager \\
</span><span style="color:#f1fa8c">      --v=2 \\
</span><span style="color:#f1fa8c">      --logtostderr=true \\
</span><span style="color:#f1fa8c">      --bind-address=127.0.0.1 \\
</span><span style="color:#f1fa8c">      --root-ca-file=/etc/kubernetes/pki/ca.pem \\
</span><span style="color:#f1fa8c">      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\
</span><span style="color:#f1fa8c">      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\
</span><span style="color:#f1fa8c">      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\
</span><span style="color:#f1fa8c">      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\
</span><span style="color:#f1fa8c">      --leader-elect=true \\
</span><span style="color:#f1fa8c">      --use-service-account-credentials=true \\
</span><span style="color:#f1fa8c">      --node-monitor-grace-period=40s \\
</span><span style="color:#f1fa8c">      --node-monitor-period=5s \\
</span><span style="color:#f1fa8c">      --pod-eviction-timeout=2m0s \\
</span><span style="color:#f1fa8c">      --controllers=*,bootstrapsigner,tokencleaner \\
</span><span style="color:#f1fa8c">      --allocate-node-cidrs=true \\
</span><span style="color:#f1fa8c">      --cluster-cidr=${CLUSTER_CIDR} \\
</span><span style="color:#f1fa8c">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\
</span><span style="color:#f1fa8c">      --node-cidr-mask-size=24
</span><span style="color:#f1fa8c">      
</span><span style="color:#f1fa8c">Restart=always
</span><span style="color:#f1fa8c">RestartSec=10s
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Install]
</span><span style="color:#f1fa8c">WantedBy=multi-user.target
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><p>启动controller-manager （所有matser节点）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl daemon-reload <span style="color:#ff79c6">&amp;&amp;</span> systemctl restart kube-controller-manager
</code></pre></div><h4 id="73配置kube-scheduler-service所有master节点">7.3、配置kube-scheduler service（所有Master节点）</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /usr/lib/systemd/system//kube-scheduler.service <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">[Unit]
</span><span style="color:#f1fa8c">Description=Kubernetes Scheduler
</span><span style="color:#f1fa8c">Documentation=https://github.com/kubernetes/kubernetes
</span><span style="color:#f1fa8c">After=network.target
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Service]
</span><span style="color:#f1fa8c">ExecStart=/usr/local/bin/kube-scheduler \\
</span><span style="color:#f1fa8c">      --v=2 \\
</span><span style="color:#f1fa8c">      --logtostderr=true \\
</span><span style="color:#f1fa8c">      --address=127.0.0.1 \\
</span><span style="color:#f1fa8c">      --leader-elect=true \\
</span><span style="color:#f1fa8c">      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">Restart=always
</span><span style="color:#f1fa8c">RestartSec=10s
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Install]
</span><span style="color:#f1fa8c">WantedBy=multi-user.target
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><p>启动scheduler（所有matser节点）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl daemon-reload <span style="color:#ff79c6">&amp;&amp;</span> systemctl restart kube-scheduler
</code></pre></div><h3 id="八tls-bootstrapping配置">八、TLS Bootstrapping配置</h3>
<h4 id="81创建bootstrapmaster01节点">8.1、创建bootstrap（Master01节点）</h4>
<p><em><strong>注意，如果不是高可用集群，192.168.1.246:8443改为master01的地址，8443改为apiserver的端口，默认是6443</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl config set-cluster kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --certificate-authority<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --embed-certs<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --server<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_APISERVER</span><span style="color:#f1fa8c">}</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config set-credentials tls-bootstrap-token-user <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --token<span style="color:#ff79c6">=</span>c8ad9c.2e4d610cf3e7426e <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config set-context tls-bootstrap-token-user@kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --cluster<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --user<span style="color:#ff79c6">=</span>tls-bootstrap-token-user <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

kubectl config use-context tls-bootstrap-token-user@kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#6272a4">#注意：如果要修改bootstrap.secret.yaml的token-id和token-secret，需要保证下图红圈内的字符串一致的，并且位数是一样的。还要保证上个命令的黄色字体：c8ad9c.2e4d610cf3e7426e与你修改的字符串要一致</span>

<span style="color:#ff79c6">apiVersion</span>: v1
<span style="color:#ff79c6">kind</span>: Secret
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: bootstrap-token-c8ad9c
  <span style="color:#ff79c6">namespace</span>: kube-system
<span style="color:#ff79c6">type</span>: bootstrap.kubernetes.io/token
<span style="color:#ff79c6">stringData</span>:
  <span style="color:#ff79c6">description</span>: <span style="color:#f1fa8c">&#34;The default bootstrap token generated by &#39;kubelet &#39;.&#34;</span>
  <span style="color:#ff79c6">token-id</span>: c8ad9c   <span style="color:#6272a4">#这个跟metadata.name 后面那个一样</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl create -f bootstrap/bootstrap.secret.yaml 
secret/bootstrap-token-c8ad9c created
clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created
clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</code></pre></div><h3 id="九node节点配置">九、Node节点配置</h3>
<h4 id="91kubelet配置">9.1、Kubelet配置</h4>
<p><em><strong>注意：如果更改了k8s的service网段，需要更改kubelet-conf.yaml 的clusterDNS:配置，改成k8s Service网段的第十个地址，比如10.96.0.10（k8s的service网段开始设置的是10.96.0.0/12）</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /etc/kubernetes/kubelet-conf.yaml <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">apiVersion: kubelet.config.k8s.io/v1beta1
</span><span style="color:#f1fa8c">kind: KubeletConfiguration
</span><span style="color:#f1fa8c">address: 0.0.0.0
</span><span style="color:#f1fa8c">port: 10250
</span><span style="color:#f1fa8c">readOnlyPort: 10255
</span><span style="color:#f1fa8c">authentication:
</span><span style="color:#f1fa8c">  anonymous:
</span><span style="color:#f1fa8c">    enabled: false
</span><span style="color:#f1fa8c">  webhook:
</span><span style="color:#f1fa8c">    cacheTTL: 2m0s
</span><span style="color:#f1fa8c">    enabled: true
</span><span style="color:#f1fa8c">  x509:
</span><span style="color:#f1fa8c">    clientCAFile: /etc/kubernetes/pki/ca.pem
</span><span style="color:#f1fa8c">authorization:
</span><span style="color:#f1fa8c">  mode: Webhook
</span><span style="color:#f1fa8c">  webhook:
</span><span style="color:#f1fa8c">    cacheAuthorizedTTL: 5m0s
</span><span style="color:#f1fa8c">    cacheUnauthorizedTTL: 30s
</span><span style="color:#f1fa8c">cgroupDriver: systemd
</span><span style="color:#f1fa8c">cgroupsPerQOS: true
</span><span style="color:#f1fa8c">clusterDNS:
</span><span style="color:#f1fa8c">- ${CLUSTER_DNS_SVC_IP}
</span><span style="color:#f1fa8c">clusterDomain: cluster.local
</span><span style="color:#f1fa8c">containerLogMaxFiles: 5
</span><span style="color:#f1fa8c">containerLogMaxSize: 10Mi
</span><span style="color:#f1fa8c">contentType: application/vnd.kubernetes.protobuf
</span><span style="color:#f1fa8c">cpuCFSQuota: true
</span><span style="color:#f1fa8c">cpuManagerPolicy: none
</span><span style="color:#f1fa8c">cpuManagerReconcilePeriod: 10s
</span><span style="color:#f1fa8c">enableControllerAttachDetach: true
</span><span style="color:#f1fa8c">enableDebuggingHandlers: true
</span><span style="color:#f1fa8c">enforceNodeAllocatable:
</span><span style="color:#f1fa8c">- pods
</span><span style="color:#f1fa8c">eventBurst: 10
</span><span style="color:#f1fa8c">eventRecordQPS: 5
</span><span style="color:#f1fa8c">evictionHard:
</span><span style="color:#f1fa8c">  imagefs.available: 15%
</span><span style="color:#f1fa8c">  memory.available: 100Mi
</span><span style="color:#f1fa8c">  nodefs.available: 10%
</span><span style="color:#f1fa8c">  nodefs.inodesFree: 5%
</span><span style="color:#f1fa8c">evictionPressureTransitionPeriod: 5m0s
</span><span style="color:#f1fa8c">failSwapOn: true
</span><span style="color:#f1fa8c">fileCheckFrequency: 20s
</span><span style="color:#f1fa8c">hairpinMode: promiscuous-bridge
</span><span style="color:#f1fa8c">healthzBindAddress: 127.0.0.1
</span><span style="color:#f1fa8c">healthzPort: 10248
</span><span style="color:#f1fa8c">httpCheckFrequency: 20s
</span><span style="color:#f1fa8c">imageGCHighThresholdPercent: 85
</span><span style="color:#f1fa8c">imageGCLowThresholdPercent: 80
</span><span style="color:#f1fa8c">imageMinimumGCAge: 2m0s
</span><span style="color:#f1fa8c">iptablesDropBit: 15
</span><span style="color:#f1fa8c">iptablesMasqueradeBit: 14
</span><span style="color:#f1fa8c">kubeAPIBurst: 10
</span><span style="color:#f1fa8c">kubeAPIQPS: 5
</span><span style="color:#f1fa8c">makeIPTablesUtilChains: true
</span><span style="color:#f1fa8c">maxOpenFiles: 1000000
</span><span style="color:#f1fa8c">maxPods: 110
</span><span style="color:#f1fa8c">nodeStatusUpdateFrequency: 10s
</span><span style="color:#f1fa8c">oomScoreAdj: -999
</span><span style="color:#f1fa8c">podPidsLimit: -1
</span><span style="color:#f1fa8c">registryBurst: 10
</span><span style="color:#f1fa8c">registryPullQPS: 5
</span><span style="color:#f1fa8c">resolvConf: /etc/resolv.conf
</span><span style="color:#f1fa8c">rotateCertificates: true
</span><span style="color:#f1fa8c">runtimeRequestTimeout: 2m0s
</span><span style="color:#f1fa8c">serializeImagePulls: true
</span><span style="color:#f1fa8c">staticPodPath: /etc/kubernetes/manifests
</span><span style="color:#f1fa8c">streamingConnectionIdleTimeout: 4h0m0s
</span><span style="color:#f1fa8c">syncFrequency: 1m0s
</span><span style="color:#f1fa8c">volumeStatsAggPeriod: 1m0s
</span><span style="color:#f1fa8c">rotateServerCertificates: true
</span><span style="color:#f1fa8c">allowedUnsafeSysctls:
</span><span style="color:#f1fa8c"> - &#34;net.core*&#34;
</span><span style="color:#f1fa8c"> - &#34;net.ipv4.*&#34;
</span><span style="color:#f1fa8c">kubeReserved:
</span><span style="color:#f1fa8c">  cpu: &#34;10m&#34;
</span><span style="color:#f1fa8c">  memory: 10Mi
</span><span style="color:#f1fa8c">  ephemeral-storage: 10Mi
</span><span style="color:#f1fa8c">systemReserved:
</span><span style="color:#f1fa8c">  cpu: &#34;1&#34;
</span><span style="color:#f1fa8c">  memory: 20Mi
</span><span style="color:#f1fa8c">  ephemeral-storage: 1Gi
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /usr/lib/systemd/system/kubelet.service <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">[Unit]
</span><span style="color:#f1fa8c">Description=Kubernetes Kubelet
</span><span style="color:#f1fa8c">Documentation=https://github.com/kubernetes/kubernetes
</span><span style="color:#f1fa8c">After=docker.service
</span><span style="color:#f1fa8c">Requires=docker.service
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Service]
</span><span style="color:#f1fa8c">ExecStart=/usr/local/bin/kubelet \\
</span><span style="color:#f1fa8c">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig \\
</span><span style="color:#f1fa8c">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
</span><span style="color:#f1fa8c">    --network-plugin=cni \\
</span><span style="color:#f1fa8c">    --cni-conf-dir=/etc/cni/net.d \\
</span><span style="color:#f1fa8c">    --cni-bin-dir=/opt/cni/bin \\
</span><span style="color:#f1fa8c">    --cgroup-driver=cgroupfs \\
</span><span style="color:#f1fa8c">    --config=/etc/kubernetes/kubelet-conf.yaml \\
</span><span style="color:#f1fa8c">    --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2 \\
</span><span style="color:#f1fa8c">    --node-labels=node.kubernetes.io/node=&#39;&#39; \\
</span><span style="color:#f1fa8c">    --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 \\ --image-pull-progress-deadline=30m
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">Restart=always
</span><span style="color:#f1fa8c">StartLimitInterval=0
</span><span style="color:#f1fa8c">RestartSec=10
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Install]
</span><span style="color:#f1fa8c">WantedBy=multi-user.target
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><p>启动kubelet</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl daemon-reload <span style="color:#ff79c6">&amp;&amp;</span> systemctl restart kubelet
</code></pre></div><p>查看集群状态（matser01上）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get node
NAME           STATUS     ROLES    AGE     VERSION
k8s-master01   NotReady   &lt;none&gt;   3m48s   v1.20.0
k8s-master02   NotReady   &lt;none&gt;   3m48s   v1.20.0
k8s-master03   NotReady   &lt;none&gt;   3m48s   v1.20.0
k8s-node01     NotReady   &lt;none&gt;   3m47s   v1.20.0
k8s-node02     NotReady   &lt;none&gt;   3m48s   v1.20.0
</code></pre></div><h4 id="92kube-proxy配置">9.2、kube-proxy配置</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl -n kube-system create serviceaccount kube-proxy

kubectl create clusterrolebinding system:kube-proxy <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --clusterrole system:node-proxier <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --serviceaccount kube-system:kube-proxy

<span style="color:#8be9fd;font-style:italic">SECRET</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>kubectl -n kube-system get sa/kube-proxy <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --output<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">jsonpath</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;{.secrets[0].name}&#39;</span><span style="color:#ff79c6">)</span>

<span style="color:#8be9fd;font-style:italic">JWT_TOKEN</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>kubectl -n kube-system get secret/<span style="color:#8be9fd;font-style:italic">$SECRET</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>--output<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">jsonpath</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;{.data.token}&#39;</span> | base64 -d<span style="color:#ff79c6">)</span>

kubectl config set-cluster kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --certificate-authority<span style="color:#ff79c6">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --embed-certs<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">true</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --server<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">KUBE_APISERVER</span><span style="color:#f1fa8c">}</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/kube-proxy.kubeconfig

kubectl config set-credentials kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --token<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">JWT_TOKEN</span><span style="color:#f1fa8c">}</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/kube-proxy.kubeconfig

kubectl config set-context kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --cluster<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --user<span style="color:#ff79c6">=</span>kubernetes <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>    --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/kube-proxy.kubeconfig

kubectl config use-context kubernetes --kubeconfig<span style="color:#ff79c6">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</code></pre></div><p>如果更改了集群Pod的网段，需要更改kube-proxy/kube-proxy.conf的clusterCIDR: 172.16.0.0/12参数为pod的网段。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /etc/kubernetes/kube-proxy.conf <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span><span style="color:#f1fa8c">bindAddress: 0.0.0.0
</span><span style="color:#f1fa8c">clientConnection:
</span><span style="color:#f1fa8c">  acceptContentTypes: &#34;&#34;
</span><span style="color:#f1fa8c">  burst: 10
</span><span style="color:#f1fa8c">  contentType: application/vnd.kubernetes.protobuf
</span><span style="color:#f1fa8c">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
</span><span style="color:#f1fa8c">  qps: 5
</span><span style="color:#f1fa8c">clusterCIDR: ${CLUSTER_CIDR}
</span><span style="color:#f1fa8c">configSyncPeriod: 15m0s
</span><span style="color:#f1fa8c">conntrack:
</span><span style="color:#f1fa8c">  max: null
</span><span style="color:#f1fa8c">  maxPerCore: 32768
</span><span style="color:#f1fa8c">  min: 131072
</span><span style="color:#f1fa8c">  tcpCloseWaitTimeout: 1h0m0s
</span><span style="color:#f1fa8c">  tcpEstablishedTimeout: 24h0m0s
</span><span style="color:#f1fa8c">enableProfiling: false
</span><span style="color:#f1fa8c">healthzBindAddress: 0.0.0.0:10256
</span><span style="color:#f1fa8c">hostnameOverride: &#34;&#34;
</span><span style="color:#f1fa8c">iptables:
</span><span style="color:#f1fa8c">  masqueradeAll: false
</span><span style="color:#f1fa8c">  masqueradeBit: 14
</span><span style="color:#f1fa8c">  minSyncPeriod: 0s
</span><span style="color:#f1fa8c">  syncPeriod: 30s
</span><span style="color:#f1fa8c">ipvs:
</span><span style="color:#f1fa8c">  masqueradeAll: true
</span><span style="color:#f1fa8c">  minSyncPeriod: 5s
</span><span style="color:#f1fa8c">  scheduler: &#34;rr&#34;
</span><span style="color:#f1fa8c">  syncPeriod: 30s
</span><span style="color:#f1fa8c">kind: KubeProxyConfiguration
</span><span style="color:#f1fa8c">metricsBindAddress: 127.0.0.1:10249
</span><span style="color:#f1fa8c">mode: &#34;ipvs&#34;
</span><span style="color:#f1fa8c">nodePortAddresses: null
</span><span style="color:#f1fa8c">oomScoreAdj: -999
</span><span style="color:#f1fa8c">portRange: &#34;&#34;
</span><span style="color:#f1fa8c">udpIdleTimeout: 250ms
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><p>配置文件（master01上）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; /usr/lib/systemd/system/kube-proxy.service <span style="color:#f1fa8c">&lt;&lt;EFO
</span><span style="color:#f1fa8c">[Unit]
</span><span style="color:#f1fa8c">Description=Kubernetes Kube Proxy
</span><span style="color:#f1fa8c">Documentation=https://github.com/kubernetes/kubernetes
</span><span style="color:#f1fa8c">After=network.target
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Service]
</span><span style="color:#f1fa8c">ExecStart=/usr/local/bin/kube-proxy \\
</span><span style="color:#f1fa8c">  --config=/etc/kubernetes/kube-proxy.conf \\
</span><span style="color:#f1fa8c">  --v=2
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">Restart=always
</span><span style="color:#f1fa8c">RestartSec=10s
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">[Install]
</span><span style="color:#f1fa8c">WantedBy=multi-user.target
</span><span style="color:#f1fa8c">EFO</span>
</code></pre></div><p>启动kube-proxy（所有节点）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl daemon-reload <span style="color:#ff79c6">&amp;&amp;</span> systemctl restart kube-proxy
</code></pre></div><h3 id="十安装calico">十、安装Calico</h3>
<h4 id="101安装calico在master01上">10.1、安装Calico（在master01上）</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#6272a4"># 修改calico-etcd.yaml的以下位置</span>
sed -i <span style="color:#f1fa8c">&#39;s#etcd_endpoints: &#34;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&#34;#etcd_endpoints: &#34;${ETCD_ENDPOINTS}&#34;#g&#39;</span> calico-etcd.yaml

<span style="color:#8be9fd;font-style:italic">ETCD_CA</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">`</span>cat /etc/kubernetes/pki/etcd/etcd-ca.pem | base64 | tr -d <span style="color:#f1fa8c">&#39;\n&#39;</span><span style="color:#f1fa8c">`</span>
<span style="color:#8be9fd;font-style:italic">ETCD_CERT</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">`</span>cat /etc/kubernetes/pki/etcd/etcd.pem | base64 | tr -d <span style="color:#f1fa8c">&#39;\n&#39;</span><span style="color:#f1fa8c">`</span>
<span style="color:#8be9fd;font-style:italic">ETCD_KEY</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">`</span>cat /etc/kubernetes/pki/etcd/etcd-key.pem | base64 | tr -d <span style="color:#f1fa8c">&#39;\n&#39;</span><span style="color:#f1fa8c">`</span>

sed -i <span style="color:#f1fa8c">&#34;s@# etcd-key: null@etcd-key: </span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">ETCD_KEY</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">@g; s@# etcd-cert: null@etcd-cert: </span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">ETCD_CERT</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">@g; s@# etcd-ca: null@etcd-ca: </span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">ETCD_CA</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">@g&#34;</span> calico-etcd.yaml

sed -i <span style="color:#f1fa8c">&#39;s#etcd_ca: &#34;&#34;#etcd_ca: &#34;/calico-secrets/etcd-ca&#34;#g; s#etcd_cert: &#34;&#34;#etcd_cert: &#34;/calico-secrets/etcd-cert&#34;#g; s#etcd_key: &#34;&#34; #etcd_key: &#34;/calico-secrets/etcd-key&#34; #g&#39;</span> calico-etcd.yaml

<span style="color:#6272a4"># 更改此处为自己的pod网段</span>
sed -i <span style="color:#f1fa8c">&#39;s@# - name: CALICO_IPV4POOL_CIDR@- name: CALICO_IPV4POOL_CIDR@g; s@#   value: &#34;192.168.0.0/16&#34;@  value: &#39;</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">CLUSTER_CIDR</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">&#39;@g&#39;</span> calico-etcd.yaml
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">[</span>root@k8s-master01 calico<span style="color:#ff79c6">]</span><span style="color:#6272a4"># kubectl apply -f calico/calico-etcd.yaml</span>
</code></pre></div><h3 id="十一安装coredns">十一、安装CoreDNS</h3>
<p><em><strong>如果更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ff79c6">[</span>root@k8s-master01<span style="color:#ff79c6">]</span><span style="color:#6272a4"># sed -i &#34;s#10.96.0.10#10.96.0.10#g&#34; CoreDNS/coredns.yaml</span>

<span style="color:#ff79c6">[</span>root@k8s-master01<span style="color:#ff79c6">]</span><span style="color:#6272a4"># kubectl  create -f CoreDNS/coredns.yaml</span>
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
</code></pre></div><h3 id="十二安装metrics-server">十二、安装Metrics Server</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl create -f metrics-server-0.4.x/
serviceaccount/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
service/metrics-server created
deployment.apps/metrics-server created
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
</code></pre></div><p>等待metrics server启动然后查看状态</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl  top node             
NAME           CPU<span style="color:#ff79c6">(</span>cores<span style="color:#ff79c6">)</span>   CPU%   MEMORY<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">)</span>   MEMORY%   
k8s-master01   384m         19%    1110Mi          59%       
k8s-master02   334m         16%    1086Mi          58%       
k8s-master03   324m         16%    1043Mi          55%       
k8s-node01     208m         10%    573Mi           30%       
k8s-node02     180m         9%     534Mi           28%
</code></pre></div><h3 id="十三安装dashboard">十三、安装dashboard</h3>
<p><em><strong>Dashboard用于展示集群中的各类资源，同时也可以通过Dashboard实时查看Pod的日志和在容器中执行一些命令等。</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl  create -f dashboard/
serviceaccount/admin-user created
clusterrolebinding.rbac.authorization.k8s.io/admin-user created
namespace/kubernetes-dashboard created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created
</code></pre></div><p>查看token值</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl -n kube-system describe secret <span style="color:#ff79c6">$(</span>kubectl -n kube-system get secret | grep admin-user | awk <span style="color:#f1fa8c">&#39;{print $1}&#39;</span><span style="color:#ff79c6">)</span>
</code></pre></div><p>登录dashboard</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#6272a4"># 更改dashboard的svc为NodePort</span>
kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
<span style="color:#6272a4">#将type: ClusterIP更改为 type: NodePort</span>

<span style="color:#6272a4"># 查看端口号</span>
kubectl get svc kubernetes-dashboard -n kubernetes-dashboard
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>         AGE
kubernetes-dashboard   NodePort   10.96.77.112   &lt;none&gt;        443:30902/TCP   4m10s

<span style="color:#6272a4"># 根据自己的实例端口号，通过任意安装了kube-proxy的宿主机或者VIP的IP+端口即可访问到dashboard</span>
页面访问：https://192.168.1.246:30902/
</code></pre></div><h2 id="附录">附录</h2>
<h3 id="参考文档">参考文档</h3>
<p>1.1 <a href="https://ywnz.com/linuxyffq/3903.html">在Ubuntu 18.04 LTS系统上安装和配置Dnsmasq的步骤</a></p>

          <h2>微信公众号</h2>
<p>扫描下面的二维码关注我们的微信公众帐号，在微信公众帐号中回复◉加群◉即可加入到我们的 kubernetes 讨论群里面共同学习。</p>
<img src="https://bxdc-static.oss-cn-beijing.aliyuncs.com/images/qrcode.png" alt="wechat-account-qrcode">

  
          
            <div class="entry-shang text-center">
    <p>「真诚赞赏，手留余香」</p>
    <button class="zs show-zs btn btn-bred">赞赏</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
    <div class="zs-modal-head">
        <button type="button" class="close">×</button>
        <span class="author"><img src="/img/avatar.jpeg"/>阳明</span>
        <p class="tip"><i></i><span>请我喝杯咖啡？</span></p>
    </div>
    <div class="zs-modal-body">
        <div class="zs-modal-btns">
            <button class="btn btn-blink" data-num="2">2元</button>
            <button class="btn btn-blink" data-num="5">5元</button>
            <button class="btn btn-blink" data-num="10">10元</button>
            <button class="btn btn-blink" data-num="50">50元</button>
            <button class="btn btn-blink" data-num="100">100元</button>
            <button class="btn btn-blink" data-num="1">任意金额</button>
        </div>
        <div class="zs-modal-pay">
            <button class="btn btn-bred" id="pay-text">2元</button>
            <p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
            <img src="/img/wechat-2.png" id="pay-image"/>
        </div>
    </div>
    <div class="zs-modal-footer">
        <span class="zs-wechat"><img src="/img/wechat-btn.png"/></span>
    </div>
</div>
          
          
            



          
        </article>
  
        
          

<h3>相关文章</h3>
<ul style="margin-bottom: 25px;">
    
    <li><a href="/post/devops/docker/devops-docker-command/">Docker 常用命令</a></li>
    
    <li><a href="/post/devops/docker/devops-docker-install/">Docker Install</a></li>
    
    <li><a href="/post/devops/docker/devops-docker-docker/">Docker</a></li>
    
    <li><a href="/post/devops/linux/devops-linux-rsync/">Linux Rsync 文件同步</a></li>
    
    <li><a href="/post/devops/linux/devops-linux-permisssions/">Linux Permisssions(文件权限)</a></li>
    
    <li><a href="/post/devops/linux/devops-linux-timedatectl/">Linux使用Timedatectl修改时区和时间</a></li>
    
    <li><a href="/post/devops/linux/devops-linux-zabbix/">Linux安装Zabbix</a></li>
    
    <li><a href="/post/devops/database/devops-linux-mysql-utilities/">Centos7.X下编译安装MySQL Utilities</a></li>
    
    <li><a href="/post/devops/database/devops-mysql/">Linux安装MySQL</a></li>
    
    <li><a href="/post/devops/linux/devops-linux-nginx/">Linux安装Nginx源码包</a></li>
    
</ul>

        
  
        
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="/post/math/2021-05-06-matrixanalysis/" data-toggle="tooltip" data-placement="top" title="Matrix Analysis">&larr; 前一篇</a>
            </li>
          
          
        </ul>
        

        
        
        
  
        
    <div id="gitalk-container"></div>
    
    
    <link rel="stylesheet" href="/css/gitalk.css" />
    <script src="/js/gitalk.min.js"></script>
    <script>
    var gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: '',
        owner: '',
        admin: [''],
        labels: ['gitment'],
        title: 'Kubernetes Install',
        createIssueManually: true,
        id: 'DevOps-Kubernetes-Install',      
        distractionFreeMode: true  
    });
    gitalk.render('gitalk-container');
</script>


        
          

        
  
      </div>
    
    
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          <img src="/img/wechatmp.png" alt="k8s技术圈">
          
          <li>
            <a href="mailto:icnych@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          <li>
            <a href="https://github.com/cnych" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          <li>
            <a href="https://weibo.com/cnych" title="微博">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          <li>
            <a href="https://instagram.com/cnych" title="Instagram">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="/%20index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
          
          <a href="/">WoolfBreathe</a>
          
          

          &nbsp;&bull;&nbsp;
          2021
        </p>
        
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.68.3</a> powered &nbsp;&bull;&nbsp; Theme by <a
            href="https://github.com/rootsongjc/beautifulhugo">Beautiful Hugo</a> Adapted To <a
            href="https://github.com/cnych/qikqiak.com">qikqiak-blog</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src='/js/bundle.min.b7dfdd821c9f407aafd1909c145d179393173d1476e753e70269be48968a707d.js' integrity='sha256-t9/dghyfQHqv0ZCcFF0Xk5MXPRR251PnAmm&#43;SJaKcH0='></script>








  </body>
</html>

